---
name: Система ценообразования с прибылью
overview: Создаем централизованную систему цен на сервере с себестоимостью и наценкой 40%, добавляем сохранение стоимости запросов в БД, и систему тарифов для конвертации долларов в токены.
todos:
    - id: create-pricing-file
      content: Создать server/features/media/pricing.ts с себестоимостью и итоговыми ценами (+40%)
      status: completed
    - id: create-tariff-system
      content: Создать server/features/media/tariff.ts с системой тарифов (5$ = 600 токенов)
      status: completed
    - id: update-schema
      content: Добавить поля costUsd и costTokens в MediaRequest в schema.prisma
      status: completed
    - id: create-migration
      content: Создать миграцию БД для добавления полей стоимости
      status: completed
      dependencies:
          - update-schema
    - id: update-generate-route
      content: Обновить generate.ts для сохранения стоимости при создании запроса
      status: completed
      dependencies:
          - create-pricing-file
          - create-tariff-system
          - update-schema
    - id: create-pricing-api
      content: Создать API эндпоинт GET /api/media/pricing для получения цен
      status: completed
      dependencies:
          - create-pricing-file
          - create-tariff-system
    - id: update-frontend-cost-utils
      content: Обновить cost-utils.ts для использования costUsd из запросов
      status: completed
      dependencies:
          - update-schema
    - id: update-media-endpoints
      content: Добавить эндпоинт getPricing и обновить типы MediaRequest
      status: completed
      dependencies:
          - create-pricing-api
    - id: update-media-gallery
      content: Обновить media-gallery.tsx для использования costUsd из запросов
      status: completed
      dependencies:
          - update-frontend-cost-utils
---

# Система ценообразования с прибылью

## Архитектура решения

### 1. Структура цен

- **Себестоимость** - реальные затраты на генерацию (из `cost-utils.ts`)
- **Наценка** - 40% прибыли
- **Итоговая цена** = себестоимость × 1.4

### 2. Система тарифов

- Базовый тариф: **5$ = 600 токенов** (120 токенов за $1)
- Абстрактная система для добавления других тарифов в будущем
- Фиксированный курс для расчета стоимости запросов (скидки при покупке токенов = бонус пользователю)

### 3. Хранение в БД

- Добавить в `MediaRequest`: `costUsd` (Decimal) и `costTokens` (Int)
- Сохранять стоимость при создании запроса
- Это позволит видеть исторические затраты даже при изменении цен

## План реализации

### Шаг 1: Создать файл цен на сервере

**Файл:** `server/features/media/pricing.ts`

- Экспортировать объект с себестоимостью и итоговыми ценами
- Структура: `{ [model]: { costPrice: number, finalPrice: number, tokens: number } }`
- Функция для расчета токенов по тарифу

### Шаг 2: Система тарифов

**Файл:** `server/features/media/tariff.ts`

- Интерфейс `Tariff` с полями: `id`, `name`, `usdToTokensRate` (например, 120)
- Массив тарифов с возможностью расширения
- Функция `convertUsdToTokens(usd: number, tariffId?: string): number`

### Шаг 3: Миграция БД

**Файл:** `prisma/migrations/XXXX_add_request_costs/migration.sql`

- Добавить поля `costUsd Decimal(10,4)` и `costTokens Int` в таблицу `MediaRequest`
- Значения по умолчанию: NULL (для существующих запросов)

### Шаг 4: Обновить Prisma схему

**Файл:** `prisma/schema.prisma`

- Добавить поля в модель `MediaRequest`:
    ```prisma
    costUsd    Decimal?  @db.Decimal(10, 4)
    costTokens Int?
    ```

### Шаг 5: Обновить логику генерации

**Файл:** `server/features/media/routes/generate.ts`

- Использовать цены из `pricing.ts`
- Рассчитывать `costTokens` через `tariff.ts`
- Сохранять `costUsd` и `costTokens` при создании запроса

### Шаг 6: API для получения цен

**Файл:** `server/features/media/routes/pricing.ts` (новый роут)

- Эндпоинт `GET /api/media/pricing` - возвращает цены для всех моделей
- Формат: `{ [model]: { usd: number, tokens: number } }`

### Шаг 7: Обновить фронтенд

**Файл:** `src/lib/cost-utils.ts`

- Удалить `MODEL_RATES` (цены теперь с сервера)
- Оставить функции `calculateTotalChatCost` и `formatCost`
- Обновить `calculateRequestCost` для использования `costUsd` из запроса

**Файл:** `src/redux/api/media.endpoints.ts`

- Добавить эндпоинт `getPricing` для получения цен с сервера
- Обновить типы для включения `costUsd` и `costTokens` в `MediaRequest`

### Шаг 8: Обновить отображение стоимости

**Файл:** `src/components/media/media-gallery.tsx`

- Использовать `costUsd` из запросов вместо расчета на лету
- Если `costUsd` отсутствует (старые запросы), использовать расчет из текущих цен

## Файлы для изменения

1. **Новые файлы:**
    - `server/features/media/pricing.ts` - цены (себестоимость + наценка)
    - `server/features/media/tariff.ts` - система тарифов
    - `server/features/media/routes/pricing.ts` - API для получения цен

2. **Изменяемые файлы:**
    - `prisma/schema.prisma` - добавить поля стоимости
    - `server/features/media/routes/generate.ts` - сохранять стоимость
    - `src/lib/cost-utils.ts` - использовать данные из БД
    - `src/redux/api/media.endpoints.ts` - добавить эндпоинт цен
    - `src/components/media/media-gallery.tsx` - использовать costUsd из запросов

## Преимущества решения

1. ✅ Единственный источник правды - цены на сервере
2. ✅ История затрат сохраняется в БД
3. ✅ Гибкая система тарифов для будущих расширений
4. ✅ Фиксированные цены запросов (скидки = бонус пользователю)
5. ✅ Прозрачность - видно и токены, и доллары
