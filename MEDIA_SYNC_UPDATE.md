# Обновление: Синхронизация БД с файловой системой

## Проблема
При удалении файлов, которые физически отсутствуют на диске (но запись есть в БД), возникала ошибка 404. Также первоначальная загрузка была медленной из-за избыточных запросов.

## Решение

### 1. Автоматическая синхронизация при старте сервера
- Добавлена функция `syncMediaFilesWithFileSystem()` в `server/features/media/database.service.ts`
- Запускается автоматически через 5 секунд после старта сервера (не блокирует старт)
- Проверяет все записи в БД и удаляет те, для которых нет физических файлов
- Использует batch-удаление для оптимизации производительности

### 2. Улучшенная обработка удаления файлов
- Маршрут `DELETE /api/media/files/:id` теперь корректно обрабатывает ситуации, когда файл уже удален физически
- Удаляет запись из БД даже если физический файл отсутствует
- Выводит понятное сообщение о результате операции

### 3. Оптимизация загрузки данных
- Убрана избыточная полная подгрузка всех requests для улучшения производительности
- Теперь загружаются только последние 3 запроса для быстрого отображения
- MediaGallery использует только необходимые данные из кеша

## Файлы изменены
- `server/features/media/database.service.ts` - добавлена синхронизация
- `server/init.ts` - вызов синхронизации при старте
- `server/features/media/routes.ts` - улучшен маршрут удаления
- `src/routes/media/$chatId.tsx` - оптимизирована загрузка данных

## Результат
- ✅ Нет ошибок при удалении уже несуществующих файлов
- ✅ Автоматическая очистка БД от устаревших записей
- ✅ Быстрая загрузка интерфейса
- ✅ Панель медиафайлов загружается мгновенно
