generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ==================== Media Generation Models ====================

model MediaChat {
  id        Int            @id @default(autoincrement())
  name      String
  model     MediaModel     @default(NANO_BANANA)
  settings  Json           @default("{}")
  requests  MediaRequest[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([updatedAt])
  @@index([createdAt])
}

model MediaRequest {
  id           Int           @id @default(autoincrement())
  chatId       Int
  chat         MediaChat     @relation(fields: [chatId], references: [id], onDelete: Cascade)
  prompt       String
  model        MediaModel? // Модель, использованная для этого запроса
  status       RequestStatus @default(PENDING)
  taskId       String? // ID задачи от провайдера (для async генерации)
  inputFiles   String[]      @default([])
  files        MediaFile[]
  errorMessage String?
  createdAt    DateTime      @default(now())
  completedAt  DateTime?

  @@index([chatId])
  @@index([createdAt])
  @@index([status])
  @@index([chatId, createdAt])
}

model MediaFile {
  id          Int          @id @default(autoincrement())
  requestId   Int
  request     MediaRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  type        MediaType
  filename    String
  path        String?      // Локальный путь (для VIDEO и отображения IMAGE)
  url         String?      // URL на imgbb (для IMAGE, используется для отправки в нейросеть)
  previewPath String?      // Локальный путь превью (для VIDEO и отображения IMAGE)
  previewUrl  String?      // URL превью на imgbb (для IMAGE, создается асинхронно)
  size        Int?
  width       Int?         // Ширина изображения (только для IMAGE)
  height      Int?         // Высота изображения (только для IMAGE)
  createdAt   DateTime     @default(now())

  @@index([requestId])
  @@index([createdAt])
  @@index([type])
}

enum MediaModel {
  NANO_BANANA
  MIDJOURNEY
  VEO_3_1_FAST
  SORA
  // LaoZhang провайдер
  NANO_BANANA_PRO
  SORA_2
  VEO_3_1
  // Kie.ai провайдер
  KLING_2_6
  NANO_BANANA_PRO_KIEAI
  IMAGEN4_KIEAI
}

enum MediaType {
  IMAGE
  VIDEO
  AUDIO
}

enum RequestStatus {
  PENDING
  PROCESSING
  COMPLETED
  FAILED
}
