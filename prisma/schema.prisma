generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}


// ==================== User & Auth Models ====================

model User {
  id               Int                @id @default(autoincrement())
  email            String             @unique
  passwordHash     String
  role             UserRole           @default(USER)
  tokenBalance     Int                @default(0)
  telegramId       String?            // Telegram User ID для привязки через бота
  createdAt        DateTime           @default(now())
  updatedAt        DateTime           @updatedAt

  chats            MediaChat[]
  requests         MediaRequest[]
  transactions     TokenTransaction[]
  telegramGroup    TelegramGroup?      // Одна группа на пользователя
  passwordResetTokens PasswordResetToken[]

  @@index([telegramId])
}

model PasswordResetToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userId    Int
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([token])
}

model TokenTransaction {
  id          Int             @id @default(autoincrement())
  userId      Int
  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  amount      Int             // Positive for top-up, negative for spend
  type        TransactionType
  description String?
  requestId   Int?            // Optional link to a specific request
  request     MediaRequest?   @relation(fields: [requestId], references: [id])
  createdAt   DateTime        @default(now())

  @@index([userId])
  @@index([createdAt])
}

model TelegramGroup {
  id        Int      @id @default(autoincrement())
  userId    Int      @unique // Одна группа на пользователя
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  groupId   String   // Telegram Chat ID как строка
  title     String?
  createdAt DateTime @default(now())

  @@index([groupId])
}

enum UserRole {
  USER
  ADMIN
}

enum TransactionType {
  TOPUP
  SPEND
  REFUND
  BONUS
}

// ==================== Media Generation Models ====================

model MediaChat {
  id        Int            @id @default(autoincrement())
  userId    Int?           // Optional for migration compatibility, should be required later
  user      User?          @relation(fields: [userId], references: [id], onDelete: SetNull)
  name      String
  model     String         @default("NANO_BANANA_PRO_KIEAI")
  settings  Json           @default("{}")
  requests  MediaRequest[]
  createdAt DateTime       @default(now())
  updatedAt DateTime       @updatedAt

  @@index([updatedAt])
  @@index([createdAt])
  @@index([userId])
  @@index([model])
}

model MediaRequest {
  id           Int                @id @default(autoincrement())
  userId       Int?               // Optional for migration
  user         User?              @relation(fields: [userId], references: [id])
  chatId       Int
  chat         MediaChat          @relation(fields: [chatId], references: [id], onDelete: Cascade)
  prompt       String
  model        String?
  costUsd      Decimal?           @db.Decimal(10, 4)
  costTokens   Int?
  status       String             @default("PENDING")
  taskId       String?
  seed         String?
  inputFiles   String[]           @default([])
  settings     Json               @default("{}")
  files        MediaFile[]
  transactions TokenTransaction[]
  errorMessage String?
  createdAt    DateTime           @default(now())
  completedAt  DateTime?

  @@index([chatId])
  @@index([createdAt])
  @@index([status])
  @@index([chatId, createdAt])
  @@index([userId])
  @@index([model])
}

model MediaFile {
  id          Int          @id @default(autoincrement())
  requestId   Int
  request     MediaRequest @relation(fields: [requestId], references: [id], onDelete: Cascade)
  type        String       // IMAGE, VIDEO, AUDIO
  filename    String
  // Local paths (nullable, used in Dev or if downloaded)
  path        String?
  previewPath String?
  // External URLs (Primary for Prod)
  url         String?
  previewUrl  String?

  size        Int?
  width       Int?
  height      Int?
  createdAt   DateTime     @default(now())

  @@index([requestId])
  @@index([createdAt])
  @@index([type])
}

