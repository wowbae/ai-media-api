# –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –∑–∞–≥—Ä—É–∑–∫–∏

## –ü—Ä–æ–±–ª–µ–º–∞
–ó–∞–ø—Ä–æ—Å `/api/media/chats/:id?limit=3` –∑–∞–Ω–∏–º–∞–ª –æ—á–µ–Ω—å –º–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–∑–∞–≤–∏—Å–∞–ª).

## –ü—Ä–∏—á–∏–Ω—ã
1. **–û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤ –≤ –ë–î** - Prisma –¥–µ–ª–∞–ª full table scan –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–∞—Ö
2. **–°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∞–ª–∞ event loop** - –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å—É—â–µ—Å—Ç–≤–æ–≤–∞–Ω–∏—è —Ñ–∞–π–ª–æ–≤ –≤—ã–ø–æ–ª–Ω—è–ª–∞—Å—å –±–µ–∑ –ø–µ—Ä–µ—Ä—ã–≤–æ–≤
3. **–ò–∑–±—ã—Ç–æ—á–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö** - –∑–∞–≥—Ä—É–∂–∞–ª–∏—Å—å –≤—Å–µ requests —Å–æ –≤—Å–µ–º–∏ files

## –†–µ—à–µ–Ω–∏—è

### 1. –î–æ–±–∞–≤–ª–µ–Ω—ã –∏–Ω–¥–µ–∫—Å—ã –≤ –±–∞–∑—É –¥–∞–Ω–Ω—ã—Ö ‚úÖ
```sql
-- MediaChat
CREATE INDEX "MediaChat_updatedAt_idx" ON "MediaChat"("updatedAt");
CREATE INDEX "MediaChat_createdAt_idx" ON "MediaChat"("createdAt");

-- MediaRequest  
CREATE INDEX "MediaRequest_chatId_idx" ON "MediaRequest"("chatId");
CREATE INDEX "MediaRequest_createdAt_idx" ON "MediaRequest"("createdAt");
CREATE INDEX "MediaRequest_status_idx" ON "MediaRequest"("status");
CREATE INDEX "MediaRequest_chatId_createdAt_idx" ON "MediaRequest"("chatId", "createdAt");

-- MediaFile
CREATE INDEX "MediaFile_requestId_idx" ON "MediaFile"("requestId");
CREATE INDEX "MediaFile_createdAt_idx" ON "MediaFile"("createdAt");
CREATE INDEX "MediaFile_type_idx" ON "MediaFile"("type");
```

### 2. –û–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞–Ω–∞ —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è —Ñ–∞–π–ª–æ–≤ ‚úÖ
- –û–±—Ä–∞–±–æ—Ç–∫–∞ –±–∞—Ç—á–∞–º–∏ –ø–æ 100 —Ñ–∞–π–ª–æ–≤
- –ó–∞–¥–µ—Ä–∂–∫–∏ –º–µ–∂–¥—É –±–∞—Ç—á–∞–º–∏ –¥–ª—è –ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ event loop
- –ù–∞—Å—Ç–æ—è—â–∞—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ—Å—Ç—å —á–µ—Ä–µ–∑ –æ—Ç–¥–µ–ª—å–Ω—É—é —Ñ—É–Ω–∫—Ü–∏—é `performSync()`

### 3. –î–æ–±–∞–≤–ª–µ–Ω–æ –¥–µ—Ç–∞–ª—å–Ω–æ–µ –ª–æ–≥–∏—Ä–æ–≤–∞–Ω–∏–µ ‚úÖ
- –í—Ä–µ–º—è –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è –∑–∞–ø—Ä–æ—Å–æ–≤ –∫ –ë–î
- –ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã—Ö –¥–∞–Ω–Ω—ã—Ö
- –ü–æ–º–æ–≥–∞–µ—Ç –æ—Ç—Å–ª–µ–∂–∏–≤–∞—Ç—å —É–∑–∫–∏–µ –º–µ—Å—Ç–∞

## –ü—Ä–∏–º–µ–Ω–µ–Ω–∏–µ –∏–Ω–¥–µ–∫—Å–æ–≤

–ò–Ω–¥–µ–∫—Å—ã —É–∂–µ –ø—Ä–∏–º–µ–Ω–µ–Ω—ã –∫–æ–º–∞–Ω–¥–æ–π:
```bash
bunx prisma db execute --file add_indexes.sql
```

## –û–∂–∏–¥–∞–µ–º—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç
- ‚ö° –ó–∞–ø—Ä–æ—Å `/api/media/chats/:id?limit=3` –≤—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è –∑–∞ < 100ms
- ‚ö° –ü–∞–Ω–µ–ª—å –º–µ–¥–∏–∞—Ñ–∞–π–ª–æ–≤ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è –º–≥–Ω–æ–≤–µ–Ω–Ω–æ
- ‚ö° –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –Ω–µ –±–ª–æ–∫–∏—Ä—É–µ—Ç –¥—Ä—É–≥–∏–µ –∑–∞–ø—Ä–æ—Å—ã

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥
–°–º–æ—Ç—Ä–∏—Ç–µ –ª–æ–≥–∏ —Å–µ—Ä–≤–µ—Ä–∞ –¥–ª—è –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:
```
[API] üîç –ù–∞—á–∞–ª–æ –∑–∞–ø—Ä–æ—Å–∞ /chats/1 (limit=3)
[API] ‚è±Ô∏è  –ó–∞–ø—Ä–æ—Å –∫ –ë–î –≤—ã–ø–æ–ª–Ω–µ–Ω –∑–∞ XXms
[API] ‚úÖ /chats/1: –∑–∞–≥—Ä—É–∂–µ–Ω–æ –∑–∞–ø—Ä–æ—Å–æ–≤=3, –≤—Å–µ–≥–æ=X, —Ñ–∞–π–ª–æ–≤=X, –≤—Ä–µ–º—è=XXms
```
