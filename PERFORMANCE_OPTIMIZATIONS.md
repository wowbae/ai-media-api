# ‚ö° –û–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ –º–µ–¥–∏–∞-–ø–∞–Ω–µ–ª–∏

## –ü—Ä–æ–±–ª–µ–º–∞
–§–∞–π–ª—ã –ª–µ–∂–∞—Ç –ª–æ–∫–∞–ª—å–Ω–æ –≤ `/ai-media`, –Ω–æ –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –∑–∞–Ω–æ–≤–æ –ø—Ä–∏ –∫–∞–∂–¥–æ–º –æ–±–Ω–æ–≤–ª–µ–Ω–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã.

## –†–µ—à–µ–Ω–∏—è

### 1. ‚úÖ –ê–≥—Ä–µ—Å—Å–∏–≤–Ω–æ–µ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏—Ö —Ñ–∞–π–ª–æ–≤
```javascript
app.use("/media-files", express.static(path, {
  maxAge: "1y",        // –ö–µ—à–∏—Ä—É–µ–º –Ω–∞ 1 –≥–æ–¥
  immutable: true,     // –§–∞–π–ª—ã –Ω–µ –∏–∑–º–µ–Ω—è—é—Ç—Å—è (—É–Ω–∏–∫–∞–ª—å–Ω—ã–µ –∏–º–µ–Ω–∞)
  etag: true,          // ETag –¥–ª—è –≤–∞–ª–∏–¥–∞—Ü–∏–∏
  lastModified: true   // Last-Modified –¥–ª—è —É—Å–ª–æ–≤–Ω—ã—Ö –∑–∞–ø—Ä–æ—Å–æ–≤
}));
```

**–≠—Ñ—Ñ–µ–∫—Ç**: 
- –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞: —Ñ–∞–π–ª—ã —Å–∫–∞—á–∏–≤–∞—é—Ç—Å—è
- –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ: –±—Ä–∞—É–∑–µ—Ä –±–µ—Ä–µ—Ç –∏–∑ –∫–µ—à–∞ (0ms, 0 –±–∞–π—Ç)
- HTTP 304 Not Modified –ø—Ä–∏ –ø—Ä–æ–≤–µ—Ä–∫–µ

### 2. ‚úÖ –ú–∏–Ω–∏–º—É–º –¥–∞–Ω–Ω—ã—Ö –≤ /files endpoint
```javascript
select: {
  id: true,
  filename: true,
  path: true,
  previewPath: true,
  type: true,
  createdAt: true,
  size: true,
  // –ù–ï –∑–∞–≥—Ä—É–∂–∞–µ–º: request, prompt, metadata
}
```

**–≠—Ñ—Ñ–µ–∫—Ç**: –†–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ —É–º–µ–Ω—å—à–µ–Ω –Ω–∞ ~60%

### 3. ‚úÖ –õ–µ–Ω–∏–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –∏–∑–æ–±—Ä–∞–∂–µ–Ω–∏–π
```html
<img loading="lazy" ... />
```

**–≠—Ñ—Ñ–µ–∫—Ç**: –ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏—è –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è —Ç–æ–ª—å–∫–æ –ø—Ä–∏ —Å–∫—Ä–æ–ª–ª–µ –∫ –Ω–∏–º

### 4. ‚úÖ –ò–Ω–¥–µ–∫—Å—ã –ë–î
```sql
CREATE INDEX "MediaFile_createdAt_idx" ON "MediaFile"("createdAt");
CREATE INDEX "MediaFile_type_idx" ON "MediaFile"("type");
```

**–≠—Ñ—Ñ–µ–∫—Ç**: –ó–∞–ø—Ä–æ—Å—ã –∫ –ë–î –≤—ã–ø–æ–ª–Ω—è—é—Ç—Å—è –∑–∞ < 10ms

### 5. ‚úÖ –†–∞–∑–¥–µ–ª–µ–Ω–∏–µ endpoints
- `/chats/:id?limit=10` - —Ç–æ–ª—å–∫–æ 10 –ø–æ—Å–ª–µ–¥–Ω–∏—Ö —Å–æ–æ–±—â–µ–Ω–∏–π (~3 KB)
- `/files?page=1&limit=50` - –æ—Ç–¥–µ–ª—å–Ω–æ —Ñ–∞–π–ª—ã —Å –ø–∞–≥–∏–Ω–∞—Ü–∏–µ–π (~15 KB)

## –†–µ–∑—É–ª—å—Ç–∞—Ç—ã

### –î–æ –≤—Å–µ—Ö –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π
- üì¶ –†–∞–∑–º–µ—Ä: 500+ KB –∑–∞ –∑–∞–ø—Ä–æ—Å
- ‚è±Ô∏è –í—Ä–µ–º—è: 5-10 —Å–µ–∫—É–Ω–¥
- üîÑ –ö–∞–∂–¥—ã–π —Ä–∞–∑: –ø–æ–ª–Ω–∞—è –∑–∞–≥—Ä—É–∑–∫–∞

### –ü–æ—Å–ª–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–π

#### –ü–µ—Ä–≤–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
- üì¶ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: ~3 KB (—á–∞—Ç) + ~15 KB (—Ñ–∞–π–ª—ã) = **18 KB**
- ‚è±Ô∏è –í—Ä–µ–º—è: **< 500ms**
- üñºÔ∏è –ü—Ä–µ–≤—å—é: –∑–∞–≥—Ä—É–∂–∞—é—Ç—Å—è –ø–æ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏—é (lazy)

#### –ü–æ—Å–ª–µ–¥—É—é—â–∏–µ –∑–∞–≥—Ä—É–∑–∫–∏
- üì¶ –ú–µ—Ç–∞–¥–∞–Ω–Ω—ã–µ: ~18 KB
- ‚è±Ô∏è –í—Ä–µ–º—è: **< 200ms**
- üñºÔ∏è –ü—Ä–µ–≤—å—é: **–∏–∑ –∫–µ—à–∞ (0 –±–∞–π—Ç, 0ms)**
- ‚ú® HTTP 304 Not Modified

## –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ)

### Service Worker –¥–ª—è –æ—Ñ—Ñ–ª–∞–π–Ω-–¥–æ—Å—Ç—É–ø–∞
```javascript
// –ö–µ—à–∏—Ä–æ–≤–∞–Ω–∏–µ –≤—Å–µ—Ö media-files –Ω–∞–≤—Å–µ–≥–¥–∞
workbox.routing.registerRoute(
  /\/media-files\//,
  new workbox.strategies.CacheFirst()
);
```

### WebP –¥–ª—è –ø—Ä–µ–≤—å—é
- –ú–µ–Ω—å—à–∏–π —Ä–∞–∑–º–µ—Ä —Ñ–∞–π–ª–æ–≤
- –ë—ã—Å—Ç—Ä–µ–µ –∑–∞–≥—Ä—É–∑–∫–∞
- –õ—É—á—à–µ–µ —Å–∂–∞—Ç–∏–µ

### –í–∏—Ä—Ç—É–∞–ª–∏–∑–∞—Ü–∏—è —Å–ø–∏—Å–∫–∞
- –†–µ–Ω–¥–µ—Ä–∏—Ç—å —Ç–æ–ª—å–∫–æ –≤–∏–¥–∏–º—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã
- React-window –∏–ª–∏ React-virtualized
- –î–ª—è 1000+ —Ñ–∞–π–ª–æ–≤

## –ú–æ–Ω–∏—Ç–æ—Ä–∏–Ω–≥

### Network Tab (DevTools)
–ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∑–∞–≥–æ–ª–æ–≤–∫–∏ –æ—Ç–≤–µ—Ç–æ–≤:
```
Cache-Control: public, max-age=31536000, immutable
ETag: "xxx"
Last-Modified: ...
```

–ü—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∑–∞–≥—Ä—É–∑–∫–µ:
```
Status: 304 Not Modified
Size: (from disk cache)
Time: 0ms
```

### Performance

–û—Ç–∫—Ä–æ–π—Ç–µ DevTools ‚Üí Performance, –∑–∞–ø–∏—à–∏—Ç–µ –∑–∞–≥—Ä—É–∑–∫—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã:
- LCP (Largest Contentful Paint): < 1s
- FCP (First Contentful Paint): < 0.5s
- TTI (Time to Interactive): < 1s

## –ö–æ–º–∞–Ω–¥—ã –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏

```bash
# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∑–∞–≥–æ–ª–æ–≤–∫–∏ –∫–µ—à–∏—Ä–æ–≤–∞–Ω–∏—è
curl -I http://localhost:4000/media-files/images/xxx.jpg

# –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ä–∞–∑–º–µ—Ä –æ—Ç–≤–µ—Ç–∞ API
curl -s http://localhost:4000/api/media/files?page=1&limit=50 | wc -c
```
